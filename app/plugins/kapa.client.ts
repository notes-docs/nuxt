// å®šä¹‰ Kapa AI å°éƒ¨ä»¶çš„é…ç½®å‚æ•°
const kapa = {
  'key': 'kapa',
  'src': 'https://widget.kapa.ai/kapa-widget.bundle.js', // å°éƒ¨ä»¶è„šæœ¬åœ°å€
  'data-website-id': 'fb3af718-9db2-440d-9da9-14e6c5fca2aa', // ç½‘ç«™å”¯ä¸€æ ‡è¯†ç¬¦
  'data-button-hide': true, // éšè—é»˜è®¤æŒ‰é’®
  'data-project-name': 'Nuxt', // é¡¹ç›®åç§°
  'data-project-color': '#00DC82', // ä¸»é¢˜é¢œè‰²
  'data-button-text-color': '#000000', // æŒ‰é’®æ–‡å­—é¢œè‰²
  'data-project-logo': 'https://nuxt.com/assets/design-kit/icon-black.svg', // é¡¹ç›® Logo
  'data-modal-image': 'https://nuxt.com/assets/design-kit/icon-green.svg', // å¼¹çª—å›¾æ ‡
  'data-button-padding': '0.5rem', // æŒ‰é’®å†…è¾¹è·
  'data-button-width': '5.5rem', // æŒ‰é’®å®½åº¦
  'data-modal-disclaimer': 'This is a custom LLM for answering questions about Nuxt. Answers are based on the contents of the documentation, GitHub information and Stack Overflow articles. Please note that answers are generated by AI and may not be fully accurate, so please use your best judgement.',
  'data-user-analytics-fingerprint-enabled': 'true', // å¼¹çª—å…è´£å£°æ˜
  'crossorigin': false // ä¸ä½¿ç”¨è·¨åŸŸå±æ€§
} as const


// å½“ Kapa å¼¹çª—æ‰“å¼€æ—¶è§¦å‘
interface OnModalOpenArgs {
  mode: 'search' | 'ai' // å¼¹çª—çš„æ‰“å¼€æ¨¡å¼ï¼Œå¯ä»¥æ˜¯ 'search'ï¼ˆæœç´¢ï¼‰æˆ– 'ai'ï¼ˆAIé—®ç­”ï¼‰
}

// å½“ Kapa å¼¹çª—å…³é—­æ—¶è§¦å‘
interface OnModalCloseArgs {
  mode: 'search' | 'ai' // å…³é—­å‰å¼¹çª—æ‰€å¤„çš„æ¨¡å¼
}

// ç”¨æˆ·æäº¤äº†ä¸€ä¸ªæ–°é—®é¢˜æ—¶è§¦å‘
interface OnAskAIQuerySubmitArgs {
  threadId: string | null // å¯¹è¯çº¿ç¨‹ IDï¼ˆå¯èƒ½ä¸º nullï¼‰
  questionAnswerId: string // é—®é¢˜ä¸å›ç­”å¯¹çš„å”¯ä¸€æ ‡è¯†
  question: string // ç”¨æˆ·æå‡ºçš„é—®é¢˜æ–‡æœ¬
}

// ç”¨æˆ·ç‚¹å‡»äº†ç¤ºä¾‹é—®é¢˜æ—¶è§¦å‘
interface OnAskAIExampleQuerySubmitArgs {
  threadId: string | null
  questionAnswerId: string
  question: string
}

// AI å®Œæˆä¸€ä¸ªç­”æ¡ˆç”Ÿæˆåè§¦å‘
interface OnAskAIAnswerCompletedArgs {
  threadId: string // å½“å‰å¯¹è¯çº¿ç¨‹ ID
  questionAnswerId: string // å½“å‰é—®é¢˜ä¸å›ç­”å¯¹çš„ ID
  question: string // ç”¨æˆ·æé—®å†…å®¹
  answer: string // AI ç”Ÿæˆçš„å›ç­”
  conversation: { questionAnswerId: string, question: string, answer: string }[] // æ•´ä¸ªå¯¹è¯å†å²è®°å½•æ•°ç»„
}

// ç”¨æˆ·å¯¹ AI å›ç­”è¿›è¡Œåé¦ˆæ—¶è§¦å‘
interface OnAskAIFeedbackSubmitArgs {
  reaction: string // ç”¨æˆ·çš„æƒ…ç»ªååº”ï¼ˆå¦‚â€œğŸ‘â€æˆ–â€œğŸ‘â€ï¼‰
  comment: { // ç”¨æˆ·åé¦ˆçš„å…·ä½“å†…å®¹
    issue: string // é—®é¢˜æè¿°
    irrelevant: boolean // æ˜¯å¦æ— å…³
    incorrect: boolean // æ˜¯å¦é”™è¯¯
    unaddressed: boolean // æ˜¯å¦æœªè¢«è§£ç­”
  }
  threadId: string
  questionAnswerId: string
  question: string
  answer: string
  conversation: { questionAnswerId: string, question: string, answer: string }[]
}

// ç”¨æˆ·ç‚¹å‡» AI å›ç­”ä¸­çš„é“¾æ¥æ—¶è§¦å‘
interface OnAskAILinkClickArgs {
  href: string // è¢«ç‚¹å‡»çš„é“¾æ¥åœ°å€
  threadId: string
  questionAnswerId: string
  question: string
  answer: string
}

// ç”¨æˆ·ç‚¹å‡» AI å›ç­”å¼•ç”¨çš„æ¥æºæ—¶è§¦å‘
interface OnAskAISourceClickArgs {
  source: {
    title: string
    subtitle: string
    url: string
  }
  threadId: string
  questionAnswerId: string
  question: string
  answer: string
}

// ç”¨æˆ·å¤åˆ¶ AI å›ç­”å†…å®¹æ—¶è§¦å‘
interface OnAskAIAnswerCopyArgs {
  threadId: string
  questionAnswerId: string
  question: string
  answer: string
}

// ç”¨æˆ·åœæ­¢ AI å›ç­”ç”Ÿæˆæ—¶è§¦å‘
interface OnAskAIGenerationStopArgs {
  threadId: string | null // å¯¹è¯çº¿ç¨‹ ID
  question: string // æ­£åœ¨ç”Ÿæˆå›ç­”çš„é—®é¢˜
  conversation: { questionAnswerId: string, question: string, answer: string }[] // å½“å‰å¯¹è¯å†å²
}

// ç”¨æˆ·é‡ç½®å½“å‰å¯¹è¯æ—¶è§¦å‘
interface OnAskAIConversationResetArgs {
  threadId: string
  conversation: { questionAnswerId: string, question: string, answer: string }[]
}

// ç”¨æˆ·åœ¨æœç´¢å’Œ AI æ¨¡å¼ä¹‹é—´åˆ‡æ¢æ—¶è§¦å‘
interface OnModeSwitchArgs {
  mode: 'search' | 'ai'
}

// æœç´¢å®Œæˆå¹¶è¿”å›ç»“æœæ—¶è§¦å‘
interface OnSearchResultsCompletedArgs {
  query: string // ç”¨æˆ·çš„æœç´¢å…³é”®è¯
  searchResults: { title: string, subtitle: string, url: string, sourceName: string }[] // åŒ¹é…çš„æœç´¢ç»“æœåˆ—è¡¨
}

// ç”¨æˆ·ç‚¹å‡»â€œæ˜¾ç¤ºæ›´å¤šæœç´¢ç»“æœâ€æŒ‰é’®æ—¶è§¦å‘
interface OnSearchResultsShowMoreClickArgs {
  query: string
  searchResults: { title: string, subtitle: string, url: string, sourceName: string }[]
}

// ç”¨æˆ·ç‚¹å‡»æŸä¸ªæœç´¢ç»“æœæ—¶è§¦å‘
interface OnSearchResultClickArgs {
  query: string // åŸå§‹æŸ¥è¯¢è¯
  searchResult: { title: string, subtitle: string, url: string, sourceName: string } // è¢«ç‚¹å‡»çš„æœç´¢ç»“æœ
  rank: number // è¯¥ç»“æœåœ¨æœç´¢ç»“æœåˆ—è¡¨ä¸­çš„æ’å
}

interface Kapa {
  // å¼¹çª—æ‰“å¼€æ—¶
  (event: 'onModalOpen', handler: (args: OnModalOpenArgs) => void): void
  // å¼¹çª—å…³é—­æ—¶
  (event: 'onModalClose', handler: (args: OnModalCloseArgs) => void): void
  // ç”¨æˆ·æäº¤é—®é¢˜æ—¶
  (event: 'onAskAIQuerySubmit', handler: (args: OnAskAIQuerySubmitArgs) => void): void
  // ç”¨æˆ·ç‚¹å‡»ç¤ºä¾‹é—®é¢˜æ—¶
  (event: 'onAskAIExampleQuerySubmit', handler: (args: OnAskAIExampleQuerySubmitArgs) => void): void
  // AI å›ç­”ç”Ÿæˆå®Œæˆæ—¶
  (event: 'onAskAIAnswerCompleted', handler: (args: OnAskAIAnswerCompletedArgs) => void): void
  // ç”¨æˆ·å¯¹å›ç­”æäº¤åé¦ˆæ—¶
  (event: 'onAskAIFeedbackSubmit', handler: (args: OnAskAIFeedbackSubmitArgs) => void): void
  // ç”¨æˆ·ç‚¹å‡»å›ç­”ä¸­çš„é“¾æ¥æ—¶
  (event: 'onAskAILinkClick', handler: (args: OnAskAILinkClickArgs) => void): void
  // ç”¨æˆ·ç‚¹å‡»å¼•ç”¨æ¥æºæ—¶
  (event: 'onAskAISourceClick', handler: (args: OnAskAISourceClickArgs) => void): void
  // ç”¨æˆ·å¤åˆ¶å›ç­”å†…å®¹æ—¶
  (event: 'onAskAIAnswerCopy', handler: (args: OnAskAIAnswerCopyArgs) => void): void
  // ç”¨æˆ·åœæ­¢ AI ç”Ÿæˆæ—¶
  (event: 'onAskAIGenerationStop', handler: (args: OnAskAIGenerationStopArgs) => void): void
  // ç”¨æˆ·é‡ç½®å¯¹è¯æ—¶
  (event: 'onAskAIConversationReset', handler: (args: OnAskAIConversationResetArgs) => void): void
  // ç”¨æˆ·åˆ‡æ¢æœç´¢/AIæ¨¡å¼æ—¶
  (event: 'onModeSwitch', handler: (args: OnModeSwitchArgs) => void): void
  // æœç´¢ç»“æœåŠ è½½å®Œæˆæ—¶
  (event: 'onSearchResultsCompleted', handler: (args: OnSearchResultsCompletedArgs) => void): void
  // ç”¨æˆ·ç‚¹å‡»â€œæ˜¾ç¤ºæ›´å¤šâ€æœç´¢ç»“æœæ—¶
  (event: 'onSearchResultsShowMoreClick', handler: (args: OnSearchResultsShowMoreClickArgs) => void): void
  // ç”¨æˆ·ç‚¹å‡»æŸä¸ªæœç´¢ç»“æœæ—¶
  (event: 'onSearchResultClick', handler: (args: OnSearchResultClickArgs) => void): void
  // æ‰‹åŠ¨æ‰“å¼€ Kapa å¼¹çª—
  open(options?: { mode?: 'search' | 'ai', query?: string, submit?: boolean }): void
  // æ‰‹åŠ¨å…³é—­ Kapa å¼¹çª—
  close: () => void
}

/**
 * åœ¨å…¨å±€ Window æ¥å£ä¸Šå£°æ˜ Kapa ç±»å‹
 * ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨å…¨å±€ window å¯¹è±¡ä¸Šè®¿é—® Kapa AI å°éƒ¨ä»¶çš„ API
 */
declare global {
  interface Window {
    /**
     * Kapa AI å°éƒ¨ä»¶çš„å…¨å±€å®ä¾‹
     * åœ¨åŠ è½½å¤–éƒ¨è„šæœ¬åç”± Kapa è‡ªåŠ¨æ³¨å…¥åˆ° window å¯¹è±¡ä¸­
     */
    Kapa: Kapa
  }
}

/**
 * Nuxt æ’ä»¶ï¼šé›†æˆ Kapa AI æ™ºèƒ½å®¢æœå°éƒ¨ä»¶
 * æä¾› `openModal` æ–¹æ³•ç”¨äºæ‰‹åŠ¨è§¦å‘æœç´¢æˆ– AI é—®ç­”å¼¹çª—
 */
export default defineNuxtPlugin(() => {
  // ä½¿ç”¨ useScript å¼‚æ­¥åŠ è½½ Kapa å°éƒ¨ä»¶è„šæœ¬
  const script = useScript<{ Kapa: Kapa }>(kapa, {
    trigger: 'manual', // æ‰‹åŠ¨è§¦å‘åŠ è½½ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨
    // è„šæœ¬åŠ è½½åè¿”å›å…¨å±€ Kapa å¯¹è±¡
    use() {
      // è¿”å›å…¨å±€çš„ Kapa å¯¹è±¡ï¼Œä¾›åç»­ä½¿ç”¨
      return { Kapa: window.Kapa }
    }
  })

  // å‘åº”ç”¨æä¾› $kapa.openModal æ–¹æ³•
  return {
    // åˆ›å»º Nuxt æ’ä»¶ï¼Œåœ¨åº”ç”¨åˆå§‹åŒ–æ—¶åŠ è½½ï¼Œé€šè¿‡ provide å‘å…¨å±€æ³¨å…¥ $kapa å¯¹è±¡
    provide: {
      kapa: {
        /**
         * æ‰“å¼€ Kapa å¼¹çª—
         * @param q å¯é€‰çš„åˆå§‹æŸ¥è¯¢è¯ï¼Œå¦‚æœå­˜åœ¨åˆ™ä»¥ "search" æ¨¡å¼æ‰“å¼€å¹¶æäº¤æŸ¥è¯¢
         */
        async openModal(q?: string) {
          await script.load() // ç¡®ä¿ Kapa è„šæœ¬å·²åŠ è½½
          const open = await getKapaOpen() // è·å– open æ–¹æ³•

          if (q) {
            // å¦‚æœä¼ å…¥äº†æŸ¥è¯¢è¯ï¼Œåˆ™ä»¥æœç´¢æ¨¡å¼æ‰“å¼€å¹¶è‡ªåŠ¨æäº¤
            return open?.({
              mode: 'search',
              query: q,
              submit: true
            })
          }

          // é»˜è®¤æ‰“å¼€å¼¹çª—ï¼ˆä¸å¸¦æŸ¥è¯¢ï¼‰
          return open?.()
        }
      }
    }
  }
})

/**
 * ç­‰å¾… Kapa çš„ open æ–¹æ³•å¯ç”¨
 * æœ€å¤šç­‰å¾… 200 æ¬¡ï¼ˆæ¯æ¬¡ 10msï¼‰ï¼Œé˜²æ­¢è„šæœ¬æœªå®Œå…¨åŠ è½½æ—¶è°ƒç”¨å¤±è´¥
 */
async function getKapaOpen() {
  let i = 0

  do {
    const open = window.Kapa?.open
    if (open) {
      return open
    }
    await new Promise(resolve => setTimeout(resolve, 10)) // ç­‰å¾… 10ms
    i++
  } while (i < 200)
  console.log('couldn\'t load kapa') // åŠ è½½å¤±è´¥æç¤º
}
